{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ property.title }} - املاک هوشمند{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">خانه</a></li>
            <li class="breadcrumb-item"><a href="{% url 'property_list' %}">املاک</a></li>
            <li class="breadcrumb-item active">{{ property.title }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- گالری تصاویر -->
        <div class="col-lg-8 mb-4">
            <div class="glass-card">
                <div id="propertyGallery" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        {% for image in property.images.all %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                <img src="{{ image.image.url }}" class="d-block w-100" alt="{{ property.title }}">
                            </div>
                        {% empty %}
                            <div class="carousel-item active">
                                <img src="{% static 'images/no-image.jpg' %}" class="d-block w-100" alt="تصویر موجود نیست">
                            </div>
                        {% endfor %}
                    </div>
                    {% if property.images.count > 1 %}
                        <button class="carousel-control-prev" type="button" data-bs-target="#propertyGallery" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#propertyGallery" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- اطلاعات قیمت -->
        <div class="col-lg-4 mb-4">
            <div class="glass-card p-4">
                <h3 class="glow-text mb-4">اطلاعات قیمت</h3>
                <div class="price-info mb-4">
                    <div class="d-flex justify-content-between mb-3">
                        <span>قیمت کل:</span>
                        <span class="glow-text">{{ property.price|intcomma }} تومان</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>قیمت هر متر:</span>
                        <span class="glow-text">{{ property.price_per_meter|intcomma }} تومان</span>
                    </div>
                </div>

                <button class="btn btn-glow w-100 mb-3" data-bs-toggle="modal" data-bs-target="#contactModal">
                    <i class="fas fa-phone-alt me-2"></i>تماس با مشاور
                </button>

                {% if user.is_authenticated %}
                    <button class="btn btn-outline-glow w-100" id="favoriteBtn" onclick="toggleFavorite({{ property.id }})">
                        <i class="fas fa-heart me-2"></i>
                        {% if is_favorite %}
                            حذف از علاقه‌مندی‌ها
                        {% else %}
                            افزودن به علاقه‌مندی‌ها
                        {% endif %}
                    </button>
                {% endif %}
            </div>
        </div>

        <!-- مشخصات ملک -->
        <div class="col-12 mb-4">
            <div class="glass-card p-4">
                <h3 class="glow-text mb-4">مشخصات ملک</h3>
                <div class="row g-4">
                    <div class="col-md-6">
                        <ul class="property-details">
                            <li><i class="fas fa-building glow-icon"></i> نوع ملک: {{ property.get_property_type_display }}</li>
                            <li><i class="fas fa-map-marker-alt glow-icon"></i> منطقه: {{ property.get_district_display }}</li>
                            <li><i class="fas fa-ruler glow-icon"></i> متراژ: {{ property.area }} متر مربع</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="property-details">
                            <li><i class="fas fa-bed glow-icon"></i> تعداد اتاق: {{ property.rooms }}</li>
                            <li><i class="fas fa-layer-group glow-icon"></i> طبقه: {{ property.floor }} از {{ property.total_floors }}</li>
                            <li><i class="fas fa-calendar glow-icon"></i> تاریخ ثبت: {{ property.created_at|date:"Y/m/d" }}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- امکانات -->
        <div class="col-12 mb-4">
            <div class="glass-card p-4">
                <h3 class="glow-text mb-4">امکانات</h3>
                <div class="row g-3">
                    <div class="col-md-3 col-6">
                        <div class="feature-item {% if property.parking %}active{% endif %}">
                            <i class="fas fa-parking"></i>
                            <span>پارکینگ</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="feature-item {% if property.elevator %}active{% endif %}">
                            <i class="fas fa-elevator"></i>
                            <span>آسانسور</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="feature-item {% if property.storage %}active{% endif %}">
                            <i class="fas fa-box"></i>
                            <span>انباری</span>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="feature-item {% if property.balcony %}active{% endif %}">
                            <i class="fas fa-door-open"></i>
                            <span>بالکن</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- توضیحات -->
        <div class="col-12">
            <div class="glass-card p-4">
                <h3 class="glow-text mb-4">توضیحات</h3>
                <p>{{ property.description|linebreaks }}</p>
            </div>
        </div>
    </div>
</div>

{% include 'properties/includes/contact_modal.html' %}
{% endblock %}

{% block extra_css %}
<style>
    .property-details {
        list-style: none;
        padding: 0;
    }
    
    .property-details li {
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .feature-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .feature-item.active {
        background: var(--primary-glow);
    }

    .feature-item i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    .carousel-item img {
        height: 400px;
        object-fit: cover;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    function toggleFavorite(propertyId) {
        fetch(`/api/properties/${propertyId}/favorite/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const btn = document.getElementById('favoriteBtn');
            if (data.is_favorite) {
                btn.innerHTML = '<i class="fas fa-heart me-2"></i>حذف از علاقه‌مندی‌ها';
            } else {
                btn.innerHTML = '<i class="fas fa-heart me-2"></i>افزودن به علاقه‌مندی‌ها';
            }
        });
    }
</script>
{% endblock %}
